<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Introduction to Spatial Analysis in R</title>
  <meta name="description" content="Introduction to Spatial Analysis in R">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Introduction to Spatial Analysis in R" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="Doi90/EE_Intro_Spatial_Workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Introduction to Spatial Analysis in R" />
  
  
  

<meta name="author" content="Roozbeh Valavi, Jutta Beher, and David Wilkinson">


<meta name="date" content="2019-07-29">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="raster-data.html">
<link rel="next" href="plotting-in-base-r.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Intro to spatial analysis in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Home page</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="vector-data.html"><a href="vector-data.html"><i class="fa fa-check"></i><b>3</b> Vector Data</a><ul>
<li class="chapter" data-level="3.1" data-path="vector-data.html"><a href="vector-data.html#vector-data-and-features"><i class="fa fa-check"></i><b>3.1</b> Vector data and features</a></li>
<li class="chapter" data-level="3.2" data-path="vector-data.html"><a href="vector-data.html#simple-features-in-r"><i class="fa fa-check"></i><b>3.2</b> Simple features in <code>R</code></a></li>
<li class="chapter" data-level="3.3" data-path="vector-data.html"><a href="vector-data.html#sf-package"><i class="fa fa-check"></i><b>3.3</b> sf package</a><ul>
<li class="chapter" data-level="3.3.1" data-path="vector-data.html"><a href="vector-data.html#reading-and-converting-data-to-sf"><i class="fa fa-check"></i><b>3.3.1</b> Reading and converting data to <code>sf</code></a></li>
<li class="chapter" data-level="3.3.2" data-path="vector-data.html"><a href="vector-data.html#import-data-from-packages"><i class="fa fa-check"></i><b>3.3.2</b> Import data from packages</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="vector-data.html"><a href="vector-data.html#transform-coordinate-reference-system"><i class="fa fa-check"></i><b>3.4</b> Transform coordinate reference system</a></li>
<li class="chapter" data-level="3.5" data-path="vector-data.html"><a href="vector-data.html#challenge-one"><i class="fa fa-check"></i><b>3.5</b> Challenge one</a></li>
<li class="chapter" data-level="3.6" data-path="vector-data.html"><a href="vector-data.html#geometric-operations"><i class="fa fa-check"></i><b>3.6</b> Geometric operations</a><ul>
<li class="chapter" data-level="3.6.1" data-path="vector-data.html"><a href="vector-data.html#cropping-sf"><i class="fa fa-check"></i><b>3.6.1</b> Cropping sf</a></li>
<li class="chapter" data-level="3.6.2" data-path="vector-data.html"><a href="vector-data.html#buffer-and-join"><i class="fa fa-check"></i><b>3.6.2</b> Buffer and join</a></li>
<li class="chapter" data-level="3.6.3" data-path="vector-data.html"><a href="vector-data.html#spatial-join-and-intersection"><i class="fa fa-check"></i><b>3.6.3</b> Spatial join and intersection</a></li>
<li class="chapter" data-level="3.6.4" data-path="vector-data.html"><a href="vector-data.html#nearest-distance"><i class="fa fa-check"></i><b>3.6.4</b> Nearest distance</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="vector-data.html"><a href="vector-data.html#write-spatial-data"><i class="fa fa-check"></i><b>3.7</b> Write spatial data</a></li>
<li class="chapter" data-level="3.8" data-path="vector-data.html"><a href="vector-data.html#challenge-two"><i class="fa fa-check"></i><b>3.8</b> Challenge two</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="raster-data.html"><a href="raster-data.html"><i class="fa fa-check"></i><b>4</b> Raster Data</a><ul>
<li class="chapter" data-level="4.1" data-path="raster-data.html"><a href="raster-data.html#rasters-and-raster-analysis"><i class="fa fa-check"></i><b>4.1</b> Rasters and raster analysis</a></li>
<li class="chapter" data-level="4.2" data-path="raster-data.html"><a href="raster-data.html#understanding-what-a-raster-is"><i class="fa fa-check"></i><b>4.2</b> Understanding what a raster is</a></li>
<li class="chapter" data-level="4.3" data-path="raster-data.html"><a href="raster-data.html#you-can-do-any-maths-with-a-raster"><i class="fa fa-check"></i><b>4.3</b> You can do any maths with a raster!</a><ul>
<li class="chapter" data-level="4.3.1" data-path="raster-data.html"><a href="raster-data.html#optional-task"><i class="fa fa-check"></i><b>4.3.1</b> Optional task:</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="raster-data.html"><a href="raster-data.html#investigate-rasters"><i class="fa fa-check"></i><b>4.4</b> Investigate rasters</a></li>
<li class="chapter" data-level="4.5" data-path="raster-data.html"><a href="raster-data.html#reading-a-raster-into-r"><i class="fa fa-check"></i><b>4.5</b> Reading a raster into R</a></li>
<li class="chapter" data-level="4.6" data-path="raster-data.html"><a href="raster-data.html#reading-a-list-of-rasters-into-r"><i class="fa fa-check"></i><b>4.6</b> Reading a list of rasters into R</a></li>
<li class="chapter" data-level="4.7" data-path="raster-data.html"><a href="raster-data.html#challenge-one-operations-on-raster-stacks"><i class="fa fa-check"></i><b>4.7</b> Challenge One: Operations on raster stacks</a></li>
<li class="chapter" data-level="4.8" data-path="raster-data.html"><a href="raster-data.html#writing-new-rasters-to-file"><i class="fa fa-check"></i><b>4.8</b> Writing new rasters to file</a></li>
<li class="chapter" data-level="4.9" data-path="raster-data.html"><a href="raster-data.html#challenge-2-creating-categories-from-summarizing-and-combining-data"><i class="fa fa-check"></i><b>4.9</b> Challenge 2: Creating categories from summarizing and combining data</a></li>
<li class="chapter" data-level="4.10" data-path="raster-data.html"><a href="raster-data.html#preparation-for-the-reclassification-into-categories"><i class="fa fa-check"></i><b>4.10</b> Preparation for the reclassification into categories:</a></li>
<li class="chapter" data-level="4.11" data-path="raster-data.html"><a href="raster-data.html#reclassification"><i class="fa fa-check"></i><b>4.11</b> Reclassification</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="combining-vector-and-raster-data.html"><a href="combining-vector-and-raster-data.html"><i class="fa fa-check"></i><b>5</b> Combining Vector and Raster Data</a><ul>
<li class="chapter" data-level="5.1" data-path="combining-vector-and-raster-data.html"><a href="combining-vector-and-raster-data.html#challenge-1-which-climate-do-koalas-like"><i class="fa fa-check"></i><b>5.1</b> Challenge 1: Which climate do koalas like?</a></li>
<li class="chapter" data-level="5.2" data-path="combining-vector-and-raster-data.html"><a href="combining-vector-and-raster-data.html#challenge-2-extract-rasters-to-polygons-how-to-summarize-more-complex-extractions."><i class="fa fa-check"></i><b>5.2</b> Challenge 2: Extract rasters to polygons: how to summarize more complex extractions.</a></li>
<li class="chapter" data-level="5.3" data-path="combining-vector-and-raster-data.html"><a href="combining-vector-and-raster-data.html#attach-the-new-information-to-your-shapefile"><i class="fa fa-check"></i><b>5.3</b> Attach the new information to your shapefile</a></li>
<li class="chapter" data-level="5.4" data-path="combining-vector-and-raster-data.html"><a href="combining-vector-and-raster-data.html#count-points-in-polygons"><i class="fa fa-check"></i><b>5.4</b> Count points in polygons</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="plotting-in-base-r.html"><a href="plotting-in-base-r.html"><i class="fa fa-check"></i><b>6</b> Plotting in Base <code>R</code></a><ul>
<li class="chapter" data-level="6.1" data-path="plotting-in-base-r.html"><a href="plotting-in-base-r.html#challenge-1-make-a-simple-map"><i class="fa fa-check"></i><b>6.1</b> Challenge 1: Make a simple map</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="plotting-in-ggplot2.html"><a href="plotting-in-ggplot2.html"><i class="fa fa-check"></i><b>7</b> Plotting in <code>ggplot2</code></a><ul>
<li class="chapter" data-level="7.1" data-path="plotting-in-ggplot2.html"><a href="plotting-in-ggplot2.html#creating-high-quality-graphics"><i class="fa fa-check"></i><b>7.1</b> Creating high quality graphics</a></li>
<li class="chapter" data-level="7.2" data-path="plotting-in-ggplot2.html"><a href="plotting-in-ggplot2.html#grammar-of-graphics"><i class="fa fa-check"></i><b>7.2</b> Grammar of Graphics</a></li>
<li class="chapter" data-level="7.3" data-path="plotting-in-ggplot2.html"><a href="plotting-in-ggplot2.html#plotting-spatial-data-in-ggplot"><i class="fa fa-check"></i><b>7.3</b> Plotting spatial data in ggplot</a><ul>
<li class="chapter" data-level="7.3.1" data-path="plotting-in-ggplot2.html"><a href="plotting-in-ggplot2.html#plotting-vector-data"><i class="fa fa-check"></i><b>7.3.1</b> Plotting vector data</a></li>
<li class="chapter" data-level="7.3.2" data-path="plotting-in-ggplot2.html"><a href="plotting-in-ggplot2.html#different-spatial-reference-in-plotting"><i class="fa fa-check"></i><b>7.3.2</b> Different spatial reference in plotting</a></li>
<li class="chapter" data-level="7.3.3" data-path="plotting-in-ggplot2.html"><a href="plotting-in-ggplot2.html#plotting-raster-data"><i class="fa fa-check"></i><b>7.3.3</b> Plotting raster data</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Introduction to Spatial Analysis in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="combining-vector-and-raster-data" class="section level1">
<h1><span class="header-section-number">5</span> Combining Vector and Raster Data</h1>
<p>For most spatial analysis you are interested in the relationship between several layers. Sometimes you need to combine only raster layers, sometimes raster and vector data, sometimes you only work in the vector world.</p>
<p>Here are three examples of possible combinations, but of course there are many more (For example ESRI (the company behind ARC-GIS) have an extensive online help that explains many concepts and tools with text and pictures).</p>
<p>Now we want to find out 3 things:
1. How many koalas are in which temperature zone? (vector (point) &amp; raster)
2. How are the temperature zones distributed across the states? (vector (polygon) &amp; raster)
3. How many koalas are in which state? (vector (point) and vector (polygon))</p>
<p>To find out, we have to <code>intersect</code> the two different layers with each other to find out how they relate to each other. This can be done with the command <code>extract()</code> from the <code>raster</code> package. In case you have not done so, read in the shapefile of the Australian states.</p>
<p>Data: you will need to have worked through the raster part in order to have the raster with the climate categories. Of course you can try the exercise with any other raster data you are interested in. Feel free to download other species or climate information from online repositories like ALA, OBIS, or worldclim.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" title="1">states &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="st">&quot;data/AU_states.shp&quot;</span>)</a></code></pre></div>
<pre><code>## Reading layer `AU_states&#39; from data source `C:\Users\wilko\Documents\University\EE_Intro_Spatial_Workshop\data\AU_states.shp&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 8 features and 15 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: 113.156 ymin: -43.637 xmax: 153.635 ymax: -10.69
## epsg (SRID):    NA
## proj4string:    +proj=longlat +ellps=GRS80 +no_defs</code></pre>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" title="1">states1 &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="st">&quot;data/AU_states.shp&quot;</span>) <span class="co"># this is an alternative to read in vector data, some other commands do not work with st objects (see mapping challenge)</span></a></code></pre></div>
<pre><code>## OGR data source with driver: ESRI Shapefile 
## Source: &quot;C:\Users\wilko\Documents\University\EE_Intro_Spatial_Workshop\data\AU_states.shp&quot;, layer: &quot;AU_states&quot;
## with 8 features
## It has 15 fields
## Integer64 fields read as strings:  OBJECTID PLANIMETRI SYMBOL</code></pre>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" title="1"><span class="kw">as</span>(states, <span class="st">&quot;Spatial&quot;</span>)</a></code></pre></div>
<pre><code>## class       : SpatialPolygonsDataFrame 
## features    : 8 
## extent      : 113.156, 153.635, -43.637, -10.69  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=longlat +ellps=GRS80 +no_defs 
## variables   : 15
## names       : OBJECTID, FEATURETYP, STATE, FEATUREREL, ATTRIBUTER, PLANIMETRI, SOURCE,        UFI, CREATIONDA, RETIREMENT, PID, SYMBOL,                    STATENAME, SHAPE_Leng,  SHAPE_Area 
## min values  :        1,   mainland,     1,         NA,         NA,          0,     NA, FF00010107,         NA,         NA,   0,      0, Australian Capital Territory,   2.757198,   0.2338955 
## max values  :        8,   mainland,     9,         NA,         NA,          0,     NA, FF00010193,         NA,         NA,   0,      0,            Western Australia, 102.585497, 227.4586760</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" title="1"><span class="kw">plot</span>(states[<span class="st">&quot;STATE&quot;</span>])</a></code></pre></div>
<p><img src="EE_Intro_Spatial_Workshop_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" title="1">states1 &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="st">&quot;data/AU_states.shp&quot;</span>) <span class="co"># this is an alternative to read in vector data, some other commands do not work with st objects (see mapping challenge)</span></a></code></pre></div>
<pre><code>## OGR data source with driver: ESRI Shapefile 
## Source: &quot;C:\Users\wilko\Documents\University\EE_Intro_Spatial_Workshop\data\AU_states.shp&quot;, layer: &quot;AU_states&quot;
## with 8 features
## It has 15 fields
## Integer64 fields read as strings:  OBJECTID PLANIMETRI SYMBOL</code></pre>
<div id="challenge-1-which-climate-do-koalas-like" class="section level2">
<h2><span class="header-section-number">5.1</span> Challenge 1: Which climate do koalas like?</h2>
<p>When we extract data to points, each point will fall within one cell, so we don’t have to worry about summarizing data. If you have not done so yet, read in the koala data again. You also want to check if they are in the same coordinate reference system before you do you analysis.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb97-1" title="1"><span class="co"># reading csv file</span></a>
<a class="sourceLine" id="cb97-2" title="2"></a>
<a class="sourceLine" id="cb97-3" title="3">koala &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;data/koala.csv&quot;</span>)</a>
<a class="sourceLine" id="cb97-4" title="4"></a>
<a class="sourceLine" id="cb97-5" title="5"><span class="co"># convert to sf</span></a>
<a class="sourceLine" id="cb97-6" title="6"></a>
<a class="sourceLine" id="cb97-7" title="7">koala_sf &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(koala, </a>
<a class="sourceLine" id="cb97-8" title="8">                     <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;Longitude&quot;</span>, </a>
<a class="sourceLine" id="cb97-9" title="9">                                <span class="st">&quot;Latitude&quot;</span>), </a>
<a class="sourceLine" id="cb97-10" title="10">                     <span class="dt">crs =</span> <span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb97-11" title="11"></a>
<a class="sourceLine" id="cb97-12" title="12"><span class="kw">crs</span>(koala_sf)  </a></code></pre></div>
<pre><code>## [1] &quot;+proj=longlat +datum=WGS84 +no_defs&quot;</code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb99-1" title="1"><span class="kw">crs</span>(climate_au) <span class="co"># although this one is slightly longer, they are actually the same. Check out for example the EPSG website, or spatialreference.org to find out more</span></a></code></pre></div>
<pre><code>## CRS arguments:
##  +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0</code></pre>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb101-1" title="1"><span class="kw">st_crs</span>(koala_sf) &lt;-<span class="st"> </span><span class="kw">crs</span>(climate_au) <span class="co"># if they are the same, but spelled differently, or one is not defined, you can assign the crs of one layer to the other. </span></a>
<a class="sourceLine" id="cb101-2" title="2"></a>
<a class="sourceLine" id="cb101-3" title="3">koala_climate &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(climate_au,</a>
<a class="sourceLine" id="cb101-4" title="4">                                 koala_sf, </a>
<a class="sourceLine" id="cb101-5" title="5">                                 <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) </a></code></pre></div>
<p>Note: sometimes, the name of a function exists in more than one package. Here, the function <code>extract()</code> also exists in the <code>tidyverse</code>. In order to tell <code>R</code> which one you want to use, you can specify with <code>package::function()</code>. You can try out what happens when you just try to use <code>extract()</code>.</p>
<p>Check your results: Are there NA values? Why do you think there are NA values?</p>
<p>Which climate do koalas like? Often, a simple plot is more informative than a map.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb102-1" title="1"><span class="kw">hist</span>(koala_climate)</a></code></pre></div>
<p><img src="EE_Intro_Spatial_Workshop_files/figure-html/unnamed-chunk-40-1.png" width="672" /></p>
</div>
<div id="challenge-2-extract-rasters-to-polygons-how-to-summarize-more-complex-extractions." class="section level2">
<h2><span class="header-section-number">5.2</span> Challenge 2: Extract rasters to polygons: how to summarize more complex extractions.</h2>
<p>When you extract data to polygons, like the states of Australia, you potentially have a lot of different values within each state, so we have to decide what we want to do with these values</p>
<p>Note: if your vector data is not an sf-object, you might need to use <code>spTransform</code> instead of <code>st_transform</code> when reprojecting, because some packages only talk to a specific data format and can’t work with others.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb103-1" title="1"><span class="kw">crs</span>(states)</a></code></pre></div>
<pre><code>## [1] &quot;+proj=longlat +ellps=GRS80 +no_defs&quot;</code></pre>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb105-1" title="1"><span class="kw">crs</span>(climate_au)</a></code></pre></div>
<pre><code>## CRS arguments:
##  +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb107-1" title="1">states_pr &lt;-<span class="st"> </span><span class="kw">st_transform</span>(states, </a>
<a class="sourceLine" id="cb107-2" title="2">                          <span class="kw">crs</span>(climate_au))</a>
<a class="sourceLine" id="cb107-3" title="3"></a>
<a class="sourceLine" id="cb107-4" title="4">state_climate &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(climate_au, </a>
<a class="sourceLine" id="cb107-5" title="5">                                 states_pr, </a>
<a class="sourceLine" id="cb107-6" title="6">                                 <span class="dt">factors =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb107-7" title="7">                                 <span class="dt">df =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb107-8" title="8">                                 <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>Now we want to sum up all cells within each state for each category</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb108-1" title="1">class.counts &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">table</span>(state_climate<span class="op">$</span>ID,state_climate<span class="op">$</span>layer))</a></code></pre></div>
<p>What does your output look like if you don’t use the <code>as.data.frame()</code> command? Why do you think it is more useful as a <code>data.frame</code>? How would it be even more useful?</p>
</div>
<div id="attach-the-new-information-to-your-shapefile" class="section level2">
<h2><span class="header-section-number">5.3</span> Attach the new information to your shapefile</h2>
<p>To be able to use your new information in a map, we join our results onto our shapefile as new columns. This is slightly more advanced, so don’t worry if you don’t get this bit quite yet.</p>
<p><code>table()</code> gives you a summary overview for two parameters, but it is not accessible like other forms (like <code>data.frame</code> or <code>matrix</code>) in <code>R</code>, so it might be a bit tricky to attach it directly to an existing table. By transforming the results from <code>table()</code> into another format you make your life easier. When you want to join columns to an existing table and want to make sure that you don’t mess up the order, you can use a shared column for matching lines up with each other. So a bit of preparation is needed to get the results from <code>table()</code> ready for a join to the spatial data:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb109-1" title="1">class.counts &lt;-<span class="st"> </span><span class="kw">table</span>(state_climate<span class="op">$</span>ID,</a>
<a class="sourceLine" id="cb109-2" title="2">                      state_climate<span class="op">$</span>layer) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb109-3" title="3"><span class="st">  </span><span class="kw">as.matrix.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb109-4" title="4"><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb109-5" title="5"><span class="st">  </span><span class="kw">setNames</span>(<span class="kw">paste0</span>(<span class="st">&quot;class_&quot;</span>, <span class="kw">c</span>(<span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">14</span>, <span class="dv">21</span>, <span class="dv">22</span>, <span class="dv">23</span>, <span class="dv">24</span>)))</a>
<a class="sourceLine" id="cb109-6" title="6"></a>
<a class="sourceLine" id="cb109-7" title="7">class.counts<span class="op">$</span>OBJECTID &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">rownames</span>(class.counts)) <span class="co"># 1:8 not recommended</span></a>
<a class="sourceLine" id="cb109-8" title="8"></a>
<a class="sourceLine" id="cb109-9" title="9">states_pr &lt;-<span class="st"> </span><span class="kw">left_join</span>(states_pr, </a>
<a class="sourceLine" id="cb109-10" title="10">                       class.counts, </a>
<a class="sourceLine" id="cb109-11" title="11">                       <span class="dt">by =</span> <span class="st">&quot;OBJECTID&quot;</span>)</a></code></pre></div>
<p>Now we can create maps that show the cell count of the different climate categories in each state. You can plot single maps, or a combination</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb110-1" title="1"><span class="kw">plot</span>(states_pr[<span class="st">&quot;class_14&quot;</span>])</a></code></pre></div>
<p><img src="EE_Intro_Spatial_Workshop_files/figure-html/unnamed-chunk-44-1.png" width="672" /></p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb111-1" title="1"><span class="kw">plot</span>(states_pr[<span class="dv">19</span><span class="op">:</span><span class="dv">22</span>])</a></code></pre></div>
<p><img src="EE_Intro_Spatial_Workshop_files/figure-html/unnamed-chunk-44-2.png" width="672" /></p>
</div>
<div id="count-points-in-polygons" class="section level2">
<h2><span class="header-section-number">5.4</span> Count points in polygons</h2>
<p>(This is more or less what you already did in the vector part and just here for the sake of completion)</p>
<p>We can also count how many Koalas are in each state, and attach the information in the attribute table of the states:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb112-1" title="1">state_koala &lt;-<span class="st"> </span><span class="kw">st_intersection</span>(koala_sf, </a>
<a class="sourceLine" id="cb112-2" title="2">                               states_pr) </a></code></pre></div>
<pre><code>## although coordinates are longitude/latitude, st_intersection assumes that they are planar</code></pre>
<pre><code>## Warning: attribute variables are assumed to be spatially constant
## throughout all geometries</code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb115-1" title="1">state.counts &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">table</span>(state_koala<span class="op">$</span>STATENAME,</a>
<a class="sourceLine" id="cb115-2" title="2">                                    state_koala<span class="op">$</span>Species))</a>
<a class="sourceLine" id="cb115-3" title="3"></a>
<a class="sourceLine" id="cb115-4" title="4">states_pr<span class="op">$</span>koala_count &lt;-<span class="st"> </span>state.counts<span class="op">$</span>Freq</a>
<a class="sourceLine" id="cb115-5" title="5"></a>
<a class="sourceLine" id="cb115-6" title="6"><span class="kw">print</span>(state.counts)</a></code></pre></div>
<pre><code>##                           Var1                   Var2 Freq
## 1 Australian Capital Territory Phascolarctos cinereus    0
## 2              New South Wales Phascolarctos cinereus  181
## 3           Northern Territory Phascolarctos cinereus    0
## 4                   Queensland Phascolarctos cinereus   16
## 5              South Australia Phascolarctos cinereus   14
## 6                     Tasmania Phascolarctos cinereus    0
## 7                     Victoria Phascolarctos cinereus   31
## 8            Western Australia Phascolarctos cinereus    0</code></pre>
<p>If you don’t always work with package <code>sf</code>, and you still want to be really sure that things that you calculated will get filled in the right columns and rows, you can always do a merge:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb117-1" title="1">states2 &lt;-<span class="st"> </span><span class="kw">merge</span>(states1, </a>
<a class="sourceLine" id="cb117-2" title="2">                 state.counts, </a>
<a class="sourceLine" id="cb117-3" title="3">                 <span class="dt">by.x =</span> <span class="st">&quot;STATENAME&quot;</span>, </a>
<a class="sourceLine" id="cb117-4" title="4">                 <span class="dt">by.y =</span> <span class="st">&quot;Var1&quot;</span>,</a>
<a class="sourceLine" id="cb117-5" title="5">                 <span class="dt">sort =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb117-6" title="6"></a>
<a class="sourceLine" id="cb117-7" title="7"><span class="kw">head</span>(states2<span class="op">@</span>data)</a></code></pre></div>
<pre><code>##                      STATENAME OBJECTID FEATURETYP STATE FEATUREREL
## 8            Western Australia        1   mainland     9       &lt;NA&gt;
## 4                   Queensland        2   mainland     5       &lt;NA&gt;
## 5              South Australia        3   mainland     6       &lt;NA&gt;
## 7                     Victoria        4   mainland     8       &lt;NA&gt;
## 1 Australian Capital Territory        5   mainland     1       &lt;NA&gt;
## 6                     Tasmania        6   mainland     7       &lt;NA&gt;
##   ATTRIBUTER PLANIMETRI SOURCE        UFI CREATIONDA RETIREMENT PID SYMBOL
## 8       &lt;NA&gt;          0   &lt;NA&gt; FF00010129       &lt;NA&gt;       &lt;NA&gt;   0      0
## 4       &lt;NA&gt;          0   &lt;NA&gt; FF00010169       &lt;NA&gt;       &lt;NA&gt;   0      0
## 5       &lt;NA&gt;          0   &lt;NA&gt; FF00010107       &lt;NA&gt;       &lt;NA&gt;   0      0
## 7       &lt;NA&gt;          0   &lt;NA&gt; FF00010178       &lt;NA&gt;       &lt;NA&gt;   0      0
## 1       &lt;NA&gt;          0   &lt;NA&gt; FF00010181       &lt;NA&gt;       &lt;NA&gt;   0      0
## 6       &lt;NA&gt;          0   &lt;NA&gt; FF00010193       &lt;NA&gt;       &lt;NA&gt;   0      0
##   SHAPE_Leng  SHAPE_Area                   Var2 Freq
## 8 102.585497 227.4586760 Phascolarctos cinereus    0
## 4  78.230893 151.7205320 Phascolarctos cinereus   16
## 5  61.940128  91.7623310 Phascolarctos cinereus   14
## 7  35.336464  22.9619050 Phascolarctos cinereus   31
## 1   2.757198   0.2338955 Phascolarctos cinereus    0
## 6  21.742202   7.0119035 Phascolarctos cinereus    0</code></pre>
<p>Of course there are many more ways to analyse raster and vector data, this was just a first taste of common operations. Don’t forget: there are usually many different ways (including different packages and commands) to get to the same result. Public forums like stackoverflow offer a way to find alternative ways and also post specific questions when you get stuck. Don’t be shy! It is usually also a good idea to run some tests on a small dataset or subset where you can check manually that you get the result that you want and all numbers make sense.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="raster-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="plotting-in-base-r.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true,
"search": true
}
});
});
</script>

</body>

</html>
